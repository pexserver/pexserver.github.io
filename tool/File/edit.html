<!doctype html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-touch-fullscreen" content="yes" />
  <meta name="apple-mobile-web-app-title" content="PEX Server edit" />
  <link rel="icon" href="https://pexserver.github.io/libs/Assets/images/home.png" type="image/x-icon" />
  <link rel="shortcut icon" href="https://pexserver.github.io/libs/Assets/images/home.png" type="image/x-icon" />
  <title>toolsData Editor Enhanced</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root {
      --primary-color: #007bff;
      --secondary-color: #6c757d;
      --success-color: #28a745;
      --danger-color: #dc3545;
      --warning-color: #ffc107;
      --info-color: #17a2b8;
      --light-color: #f8f9fa;
      --dark-color: #343a40;
      --border-color: #dee2e6;
      --input-bg: #fff;
      --input-border: #ced4da;
      --input-focus-border: #80bdff;
      --input-focus-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
      --body-bg: #f4f7f9;
      --text-color: #212529;
      --link-color: #007bff;
      --markdown-bg: #eef2f5;
      --code-bg: #e9ecef;
      --container-bg: #ffffff;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
      --border-radius: 0.3rem;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      line-height: 1.6;
      padding: 1rem;
      background-color: var(--body-bg);
      color: var(--text-color);
      margin: 0;
      font-size: 16px;
    }

    .container {
      max-width: 960px;
      margin: 1.5rem auto;
      background-color: var(--container-bg);
      padding: 2rem;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border-color);
    }

    h1,
    h2,
    h3 {
      color: var(--dark-color);
      margin-top: 1.8em;
      margin-bottom: 1em;
      padding-bottom: 0.5em;
      border-bottom: 1px solid var(--border-color);
    }

    h1 {
      font-size: 2.2em;
      border-bottom: 2px solid var(--primary-color);
    }

    h2 {
      font-size: 1.7em;
    }

    h3 {
      font-size: 1.4em;
      border-bottom-style: dashed;
    }

    textarea,
    input[type="text"],
    input[type="date"],
    input[type="url"],
    input[type="text"][readonly] {
      display: block;
      width: 100%;
      padding: 0.65rem 0.9rem;
      margin-bottom: 0.9rem;
      font-size: 0.95rem;
      line-height: 1.5;
      color: var(--text-color);
      background-color: var(--input-bg);
      background-clip: padding-box;
      border: 1px solid var(--input-border);
      border-radius: var(--border-radius);
      transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    input[type="url"].is-base64-loaded {
      display: none !important;
    }

    .base64-loaded-message {
      font-size: 0.85em;
      color: var(--secondary-color);
      padding: 0.4rem 0.6rem;
      background-color: var(--light-color);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      margin-bottom: 0.5rem;
      display: block;
    }

    .base64-loaded-message .clear-base64-btn {
      margin-left: 10px;
      font-size: 0.9em;
      color: var(--primary-color);
      cursor: pointer;
      text-decoration: underline;
    }


    input[type="text"][readonly] {
      background-color: var(--light-color);
      opacity: 0.8;
      cursor: not-allowed;
    }

    textarea:focus,
    input:focus {
      color: var(--text-color);
      background-color: var(--input-bg);
      border-color: var(--input-focus-border);
      outline: 0;
      box-shadow: var(--input-focus-shadow);
    }

    textarea {
      min-height: 120px;
      font-family: Consolas, Monaco, "Andale Mono", "Ubuntu Mono", monospace;
      resize: vertical;
    }

    #dataInput {
      min-height: 180px;
    }

    #dataOutput {
      min-height: 220px;
      background-color: var(--code-bg);
      border-color: var(--border-color);
      font-family: Consolas, Monaco, "Andale Mono", "Ubuntu Mono", monospace;
    }

    #editForm textarea {
      min-height: 80px;
    }

    #editDetailedDescription {
      min-height: 150px;
    }

    #editDescription,
    #editDetailedDescription {
      background-color: var(--markdown-bg);
      border-left: 3px solid var(--info-color);
    }

    #editDescription:focus,
    #editDetailedDescription:focus {
      background-color: var(--input-bg);
    }

    button {
      display: inline-block;
      font-weight: 400;
      color: #fff;
      text-align: center;
      vertical-align: middle;
      cursor: pointer;
      user-select: none;
      background-color: transparent;
      border: 1px solid transparent;
      padding: 0.6rem 1.2rem;
      font-size: 1rem;
      line-height: 1.5;
      border-radius: var(--border-radius);
      transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out, transform 0.1s ease-out;
      margin: 0.3rem;
    }

    button:not(:disabled):not(.disabled) {
      cursor: pointer;
    }

    button:hover {
      filter: brightness(95%);
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }

    button:active {
      filter: brightness(90%);
      transform: translateY(0px);
    }

    button:disabled {
      opacity: 0.65;
      cursor: not-allowed;
    }

    #loadDataBtn,
    #addToolBtn,
    .tool-item button {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
      color: white;
    }

    #saveToolBtn {
      background-color: var(--success-color);
      border-color: var(--success-color);
      color: white;
    }

    #deleteToolBtn {
      background-color: var(--danger-color);
      border-color: var(--danger-color);
      color: white;
    }

    #cancelEditBtn,
    #copyOutputBtn {
      background-color: var(--secondary-color);
      border-color: var(--secondary-color);
      color: white;
    }

    #toolList {
      margin-top: 1.5rem;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      padding: 0;
      max-height: 400px;
      overflow-y: auto;
      background-color: #fff;
    }

    #toolList::-webkit-scrollbar {
      width: 8px;
    }

    #toolList::-webkit-scrollbar-track {
      background: var(--light-color);
      border-radius: 4px;
    }

    #toolList::-webkit-scrollbar-thumb {
      background-color: var(--secondary-color);
      border-radius: 4px;
      border: 2px solid var(--light-color);
    }

    #toolList::-webkit-scrollbar-thumb:hover {
      background-color: var(--dark-color);
    }

    .tool-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.9rem 1.2rem;
      border-bottom: 1px solid var(--border-color);
      transition: background-color 0.15s ease;
    }

    .tool-item:last-child {
      border-bottom: none;
    }

    .tool-item:hover {
      background-color: var(--light-color);
    }

    .tool-item span {
      flex-grow: 1;
      margin-right: 1rem;
      word-break: break-word;
    }

    .tool-item .tool-key {
      font-weight: 600;
      color: var(--primary-color);
      margin-right: 0.4rem;
      font-size: 0.9em;
      background-color: var(--light-color);
      padding: 2px 6px;
      border-radius: 3px;
      border: 1px solid var(--border-color);
    }

    .tool-item button {
      padding: 0.3rem 0.7rem;
      font-size: 0.85rem;
    }

    #editFormContainer {
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      padding: 1.8rem;
      margin-top: 1.8rem;
      background-color: #fff;
      box-shadow: var(--shadow-sm);
    }

    #editForm label {
      display: block;
      margin-bottom: 0.4rem;
      font-weight: 600;
      color: var(--dark-color);
      font-size: 0.9rem;
    }

    #editForm label .required {
      color: var(--danger-color);
      margin-left: 0.25rem;
      font-weight: bold;
    }

    .image-input-container {
      display: flex;
      flex-direction: column;
      /* Changed for better layout with message */
      gap: 5px;
      /* Adjusted gap */
      margin-bottom: 0.9rem;
    }

    .image-input-container input[type="url"] {
      flex-grow: 1;
      margin-bottom: 0;
      /* Removed default margin as container handles it */
    }

    .image-preview {
      flex-shrink: 0;
      width: 80px;
      height: 80px;
      border: 1px solid var(--border-color);
      background-color: var(--light-color);
      object-fit: contain;
      display: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      /* To indicate it's clickable for clearing Base64 */
    }

    .image-preview.has-base64 {
      margin-top: 5px;
      /* Add some space when message is shown */
    }

    input.pasting {
      opacity: 0.7;
      cursor: progress;
      background-color: var(--warning-color) !important;
      border-color: darken(var(--warning-color), 10%) !important;
    }

    #editForm .form-buttons {
      margin-top: 1.5rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border-color);
      display: flex;
      flex-wrap: wrap;
      gap: 0.8rem;
      justify-content: flex-start;
    }

    .hidden {
      display: none !important;
    }

    .error,
    .paste-error {
      color: var(--danger-color);
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      padding: 0.75rem 1.25rem;
      border-radius: var(--border-radius);
      margin-top: 0.8rem;
      font-size: 0.9rem;
    }

    #saveError {
      margin-top: 1rem;
    }

    .paste-error {
      font-size: 0.85rem;
      margin-top: 0.2rem;
      /* Adjusted from -0.6rem */
      margin-bottom: 0.8rem;
      display: block;
    }

    #copyStatus {
      margin-left: 0.8rem;
      font-weight: bold;
      font-size: 0.9rem;
      padding: 0.3rem 0.6rem;
      border-radius: 3px;
      transition: opacity 0.3s ease-out;
    }

    #copyStatus.success {
      color: var(--success-color);
      background-color: #d4edda;
    }

    #copyStatus.fail {
      color: var(--danger-color);
      background-color: #f8d7da;
    }

    .required {
      color: var(--danger-color);
      font-weight: bold;
      margin-left: 2px;
    }

    datalist {
      display: none;
    }

    fieldset {
      border: 1px solid var(--border-color);
      padding: 1rem 1.2rem;
      margin-top: 1.5rem;
      border-radius: var(--border-radius);
      background-color: var(--light-color);
    }

    legend {
      padding: 0 0.6rem;
      font-weight: 600;
      font-size: 1rem;
      color: var(--secondary-color);
    }

    @media (max-width: 768px) {
      body {
        padding: 0.5rem;
      }

      .container {
        padding: 1rem;
      }

      h1 {
        font-size: 1.8em;
      }

      h2 {
        font-size: 1.4em;
      }

      h3 {
        font-size: 1.2em;
      }

      textarea,
      input[type="text"],
      input[type="date"],
      input[type="url"],
      button {
        font-size: 0.95rem;
        padding: 0.6rem 0.8rem;
      }

      #editForm .form-buttons {
        flex-direction: column;
        align-items: stretch;
      }

      #editForm .form-buttons button {
        width: 100%;
        margin-bottom: 0.5rem;
      }

      /* .image-input-container {
        flex-direction: column;
        align-items: stretch;
      } */
      /* Already column from base styles */

      .image-input-container input[type="url"] {
        margin-bottom: 0.5rem;
      }

      .image-preview {
        width: 100%;
        max-width: 150px;
        height: auto;
        max-height: 150px;
        align-self: flex-start;
      }

      .paste-error {
        margin-top: 0.2rem;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>toolsData Editor <small style="font-size: 0.6em; color: var(--secondary-color)">(Enhanced)</small></h1>
    <section id="inputArea">
      <h2>1. Load toolsData</h2>
      <p>既存の <code>toolsData</code> オブジェクトの内容全体 (<code>const toolsData = { ... };</code> の <code>{...}</code>
        の部分、またはJSON形式) を以下に貼り付けて「Load Data」ボタンを押してください。</p>
      <textarea id="dataInput"
        placeholder="{ 'tool1': { appID: 'uuid-goes-here', title: 'Example Tool', }, }"></textarea>
      <button id="loadDataBtn">Load Data</button>
      <div id="loadError" class="error hidden"></div>
    </section>
    <section id="manageArea" class="hidden">
      <h2>2. Manage Tools</h2>
      <div style="margin-bottom: 1rem"><button id="addToolBtn">Add New Tool</button></div>
      <div id="toolList">
        <p style="padding: 1rem 1.2rem; color: var(--secondary-color);">Load data to see tools.</p>
      </div>
      <div id="editFormContainer" class="hidden">
        <h3 id="formTitle">Edit Tool</h3>
        <form id="editForm" novalidate="">
          <input type="hidden" id="editToolId" />
          <div>
            <label for="editAppID">App ID (UUID v4 - Auto-generated):</label>
            <input type="text" id="editAppID" readonly />
          </div>
          <div>
            <label for="editToolKey">Tool Key<span class="required">*</span> (例: 'myTool', 'utility-abc'):</label>
            <input type="text" id="editToolKey" required="" />
          </div>
          <div>
            <label for="editTitle">Title:</label>
            <input type="text" id="editTitle" />
          </div>
          <div>
            <label for="editImage">Image URL (クリップボードから画像ペースト可):</label>
            <div class="image-input-container">
              <span id="editImageBase64Status" class="base64-loaded-message hidden">
                Base64 Image Loaded. <span class="clear-base64-btn" data-target-input="editImage"
                  data-target-preview="editImagePreview" data-target-status="editImageBase64Status">Clear</span>
              </span>
              <input type="url" id="editImage" placeholder="例: ../Assets/images/tool.png またはペースト" />
              <img id="editImagePreview" src="#" alt="Image Preview" class="image-preview" data-target-input="editImage"
                data-target-preview="editImagePreview" data-target-status="editImageBase64Status" />
            </div>
            <small id="editImagePasteError" class="paste-error hidden"></small>
          </div>
          <div>
            <label for="editImageLarge">Large Image URL (クリップボードから画像ペースト可):</label>
            <div class="image-input-container">
              <span id="editImageLargeBase64Status" class="base64-loaded-message hidden">
                Base64 Image Loaded. <span class="clear-base64-btn" data-target-input="editImageLarge"
                  data-target-preview="editImageLargePreview"
                  data-target-status="editImageLargeBase64Status">Clear</span>
              </span>
              <input type="url" id="editImageLarge" placeholder="例: ../Assets/images/tool-large.png またはペースト" />
              <img id="editImageLargePreview" src="#" alt="Large Image Preview" class="image-preview"
                data-target-input="editImageLarge" data-target-preview="editImageLargePreview"
                data-target-status="editImageLargeBase64Status" />
            </div>
            <small id="editImageLargePasteError" class="paste-error hidden"></small>
          </div>
          <div>
            <label for="editVersion">Version:</label>
            <input type="text" id="editVersion" placeholder="例: 1.2.0" />
          </div>
          <div>
            <label for="editUpdated">Updated:</label>
            <input type="date" id="editUpdated" />
          </div>
          <div>
            <label for="editDescription">Description (Short) <small
                style="color: var(--info-color); font-weight: normal">(Markdown supported)</small>:</label>
            <textarea id="editDescription" placeholder="短い説明をMarkdownで入力... 例: **重要な** ツールです。"></textarea>
          </div>
          <div>
            <label for="editDetailedDescription">Detailed Description <small
                style="color: var(--info-color); font-weight: normal">(Markdown supported)</small>:</label>
            <textarea id="editDetailedDescription"
              placeholder="詳細な説明をMarkdownで入力... 例: ## 機能\n* 機能1\n* 機能2\n\n```js\nconsole.log('Hello');\n```"></textarea>
          </div>
          <fieldset>
            <legend>Download URLs</legend>
            <div><label for="editDownloadUrl">Download URL (Default/Single):</label><input type="text"
                id="editDownloadUrl" placeholder="例: ./File/tool.zip (If no platform-specific URLs)" /></div>
            <div><label for="editDownloadUrlWindows">Download URL (Windows):</label><input type="text"
                id="editDownloadUrlWindows" placeholder="例: ./File/tool_win.exe" /></div>
            <div><label for="editDownloadUrlLinux">Download URL (Linux):</label><input type="text"
                id="editDownloadUrlLinux" placeholder="例: ./File/tool_linux.tar.gz" /></div>
          </fieldset>
          <div>
            <label for="editDocsUrl">Docs URL:</label>
            <input type="url" id="editDocsUrl" placeholder="例: ./docs/tool_readme.html" />
          </div>
          <div>
            <label for="editPlatform">Platform:</label>
            <input type="text" id="editPlatform" list="platformSuggestions"
              placeholder="例: web, windows, linux (カンマ区切り)" />
            <datalist id="platformSuggestions"></datalist>
          </div>
          <div>
            <label for="editCategoryType">Category Type:</label>
            <input type="text" id="editCategoryType" list="categoryTypeSuggestions"
              placeholder="例: development, utility, minecraft" />
            <datalist id="categoryTypeSuggestions"></datalist>
          </div>
          <div class="form-buttons">
            <button type="submit" id="saveToolBtn">Save Tool</button>
            <button type="button" id="deleteToolBtn" class="hidden">Delete Tool</button>
            <button type="button" id="cancelEditBtn">Cancel</button>
          </div>
          <div id="saveError" class="error hidden"></div>
        </form>
      </div>
    </section>
    <section id="outputArea" class="hidden">
      <h2>3. Get Updated Data</h2>
      <p>編集後の <code>toolsData</code> オブジェクトです。コピーしてコードに貼り付けてください
        (JSON形式)。<br /><small>DescriptionフィールドはMarkdownから変換されたHTMLが格納されます。</small></p>
      <textarea id="dataOutput" readonly=""></textarea>
      <button id="copyOutputBtn">Copy to Clipboard</button>
      <span id="copyStatus"></span>
    </section>
  </div>
  <script>
    let currentToolsData = {};
    const suggestions = { platforms: new Set(), categoryTypes: new Set(), };
    const dataInput = document.getElementById("dataInput");
    const loadDataBtn = document.getElementById("loadDataBtn");
    const loadError = document.getElementById("loadError");
    const manageArea = document.getElementById("manageArea");
    const toolList = document.getElementById("toolList");
    const addToolBtn = document.getElementById("addToolBtn");
    const editFormContainer = document.getElementById("editFormContainer");
    const editForm = document.getElementById("editForm");
    const formTitle = document.getElementById("formTitle");
    const saveToolBtn = document.getElementById("saveToolBtn");
    const deleteToolBtn = document.getElementById("deleteToolBtn");
    const cancelEditBtn = document.getElementById("cancelEditBtn");
    const saveError = document.getElementById("saveError");
    const outputArea = document.getElementById("outputArea");
    const dataOutput = document.getElementById("dataOutput");
    const copyOutputBtn = document.getElementById("copyOutputBtn");
    const copyStatus = document.getElementById("copyStatus");
    const platformSuggestionsEl = document.getElementById("platformSuggestions");
    const categoryTypeSuggestionsEl = document.getElementById("categoryTypeSuggestions");

    const editImageInput = document.getElementById("editImage");
    const editImageLargeInput = document.getElementById("editImageLarge");
    // Previews and status messages are now retrieved dynamically or via dataset

    const editDescriptionInput = document.getElementById("editDescription");
    const editDetailedDescriptionInput = document.getElementById("editDetailedDescription");
    const editAppIDInput = document.getElementById("editAppID");

    loadDataBtn.addEventListener("click", handleLoadData);
    addToolBtn.addEventListener("click", () => showEditForm(null));
    editForm.addEventListener("submit", handleSaveTool);
    deleteToolBtn.addEventListener("click", handleDeleteTool);
    cancelEditBtn.addEventListener("click", hideEditForm);
    copyOutputBtn.addEventListener("click", copyOutputToClipboard);

    [editImageInput, editImageLargeInput].forEach(input => {
      input.addEventListener("paste", handleImagePaste);
      input.addEventListener('input', () => {
        const previewId = input.id.replace('editImage', 'editImagePreview'); // e.g. editImage -> editImagePreview
        updateImagePreview(input.id, previewId);
      });
    });

    document.querySelectorAll('.clear-base64-btn').forEach(btn => {
      btn.addEventListener('click', (event) => {
        const targetInputId = event.target.dataset.targetInput;
        const targetPreviewId = event.target.dataset.targetPreview;
        clearBase64Image(targetInputId, targetPreviewId);
      });
    });
    document.querySelectorAll('.image-preview').forEach(preview => {
      preview.addEventListener('click', (event) => {
        const targetInputId = event.target.dataset.targetInput;
        const targetPreviewId = event.target.dataset.targetPreview;
        const inputEl = document.getElementById(targetInputId);
        if (inputEl && inputEl.classList.contains('is-base64-loaded')) {
          clearBase64Image(targetInputId, targetPreviewId);
        }
      });
    });

    function generateUUIDv4() {
      if (crypto && crypto.randomUUID) {
        return crypto.randomUUID();
      } else {
        console.warn("crypto.randomUUID not available, using basic fallback.");
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
          var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
          return v.toString(16);
        });
      }
    }

    function displayError(element, message) {
      element.textContent = message;
      element.classList.remove("hidden");
    }
    function clearError(element) {
      element.textContent = "";
      element.classList.add("hidden");
    }
    function displayPasteError(inputId, message) {
      const errorElement = document.getElementById(inputId + "PasteError");
      if (errorElement) {
        errorElement.textContent = message;
        errorElement.classList.remove("hidden");
      }
    }
    function clearPasteError(inputId) {
      const errorElement = document.getElementById(inputId + "PasteError");
      if (errorElement) {
        errorElement.textContent = "";
        errorElement.classList.add("hidden");
      }
    }
    function disableButtons(disabled = true, buttonText = null) {
      const buttons = [loadDataBtn, addToolBtn, saveToolBtn, deleteToolBtn, cancelEditBtn, copyOutputBtn];
      buttons.forEach(btn => {
        if (btn) {
          btn.disabled = disabled;
          if (disabled && btn === saveToolBtn && buttonText) { btn.textContent = buttonText; }
          else if (!disabled && btn === saveToolBtn) { btn.textContent = "Save Tool"; }
          else if (disabled && btn === loadDataBtn && buttonText) { btn.textContent = buttonText; }
          else if (!disabled && btn === loadDataBtn) { btn.textContent = "Load Data"; }
        }
      });
      document.querySelectorAll('#toolList button').forEach(btn => btn.disabled = disabled);
    }

    // 画像Base64圧縮用関数
    async function compressBase64Image(base64, maxWidth = 256, maxHeight = 256, quality = 0.7) {
      return new Promise((resolve, reject) => {
        if (!base64.startsWith('data:image')) return resolve(base64); // 非画像はそのまま
        const img = new window.Image();
        img.onload = function () {
          let w = img.width, h = img.height;
          if (w > maxWidth || h > maxHeight) {
            const ratio = Math.min(maxWidth / w, maxHeight / h);
            w = Math.round(w * ratio);
            h = Math.round(h * ratio);
          }
          const canvas = document.createElement('canvas');
          canvas.width = w;
          canvas.height = h;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, w, h);
          let mime = base64.substring(5, base64.indexOf(';'));
          // JPEG優先、透明ならPNG
          if (mime !== 'image/png') mime = 'image/jpeg';
          let compressed = canvas.toDataURL(mime, quality);
          // 圧縮後の方が大きい場合は元を返す
          if (compressed.length > base64.length) resolve(base64);
          else resolve(compressed);
        };
        img.onerror = function (e) { resolve(base64); };
        img.src = base64;
      });
    }

    // 画像プレビュー更新を修正し、両方の画像が正しく切り替わるように
    async function updateImagePreview(inputId, previewId) {
      const input = document.getElementById(inputId);
      const preview = document.getElementById(previewId);
      const statusMessage = document.getElementById(inputId + 'Base64Status');
      let value = input.value.trim();
      if (value.startsWith('data:image') && value.includes(';base64,')) {
        // 圧縮処理
        value = await compressBase64Image(value);
        input.value = value;
        preview.src = value;
        preview.style.display = 'block';
        preview.classList.add('has-base64');
        input.classList.add('is-base64-loaded');
        if (statusMessage) statusMessage.classList.remove('hidden');
      } else if (value) {
        preview.src = value;
        preview.style.display = 'block';
        preview.classList.remove('has-base64');
        input.classList.remove('is-base64-loaded');
        if (statusMessage) statusMessage.classList.add('hidden');
      } else {
        preview.src = '#';
        preview.style.display = 'none';
        preview.classList.remove('has-base64');
        input.classList.remove('is-base64-loaded');
        if (statusMessage) statusMessage.classList.add('hidden');
      }
    }

    // handleImagePasteで圧縮を追加
    async function handleImagePaste(event) {
      const inputElement = event.target;
      const errorElementId = inputElement.id;
      const previewElementId = inputElement.id.replace('editImage', 'editImagePreview');
      clearPasteError(errorElementId);
      const items = (event.clipboardData || window.clipboardData)?.items;
      if (!items) { displayPasteError(errorElementId, "クリップボードデータにアクセスできません。"); return; }
      let imageFound = false;
      for (let i = 0; i < items.length; i++) {
        if (items[i].type.indexOf("image") !== -1) {
          const blob = items[i].getAsFile();
          if (!blob) { displayPasteError(errorElementId, "画像ファイルの取得に失敗しました。"); continue; }
          imageFound = true;
          event.preventDefault();
          const reader = new FileReader();
          const originalPlaceholder = inputElement.placeholder;
          reader.onloadstart = () => {
            inputElement.classList.add('pasting');
            inputElement.readOnly = true;
            inputElement.placeholder = 'Pasting image...';
          };
          reader.onload = async (e) => {
            if (e.target && typeof e.target.result === 'string') {
              // 圧縮
              const compressed = await compressBase64Image(e.target.result);
              inputElement.value = compressed;
              updateImagePreview(inputElement.id, previewElementId);
            } else { displayPasteError(errorElementId, "画像の読み込み結果が無効です。"); }
          };
          reader.onerror = (error) => {
            console.error("FileReader error:", error);
            displayPasteError(errorElementId, `画像の読み込みに失敗しました: ${error.message || error}`);
          };
          reader.onloadend = () => {
            inputElement.classList.remove('pasting');
            inputElement.readOnly = false;
            inputElement.placeholder = originalPlaceholder;
          };
          reader.readAsDataURL(blob);
          break;
        }
      }
      if (!imageFound) {
        setTimeout(() => updateImagePreview(inputElement.id, previewElementId), 0);
      }
    }

    // データ読込時にBase64画像を自動圧縮
    async function compressAllBase64ImagesInData() {
      let changed = false;
      for (const key in currentToolsData) {
        if (currentToolsData.hasOwnProperty(key)) {
          const tool = currentToolsData[key];
          for (const imgField of ['image', 'imageLarge']) {
            if (tool[imgField] && typeof tool[imgField] === 'string' && tool[imgField].startsWith('data:image')) {
              const compressed = await compressBase64Image(tool[imgField]);
              if (compressed !== tool[imgField]) {
                tool[imgField] = compressed;
                changed = true;
              }
            }
          }
        }
      }
      return changed;
    }

    // handleLoadDataに圧縮処理を追加
    async function handleLoadData() {
      disableButtons(true, "Loading...");
      clearError(loadError);
      hideEditForm();
      const inputString = dataInput.value.trim();
      let dataNeedsUpdate = false;
      if (!inputString) {
        currentToolsData = {};
        console.log("Input data is empty, initializing with empty data.");
      } else {
        try {
          let parsableString = inputString;
          if (parsableString.startsWith("const") || parsableString.startsWith("var") || parsableString.startsWith("let")) {
            parsableString = parsableString.substring(parsableString.indexOf("{"));
          }
          if (parsableString.endsWith(";")) {
            parsableString = parsableString.slice(0, -1);
          }
          currentToolsData = new Function(`return ${parsableString}`)();
          if (typeof currentToolsData !== "object" || currentToolsData === null || Array.isArray(currentToolsData)) {
            throw new Error("Parsed data is not a valid object map.");
          }
          console.log("Data loaded via Function constructor:", Object.keys(currentToolsData).length);
        } catch (error) {
          console.warn("Parsing as JS object literal failed, trying JSON:", error);
          try {
            currentToolsData = JSON.parse(inputString);
            if (typeof currentToolsData !== "object" || currentToolsData === null || Array.isArray(currentToolsData)) {
              throw new Error("Parsed JSON is not a valid object map.");
            }
            console.log("Data loaded via JSON.parse:", Object.keys(currentToolsData).length);
          } catch (jsonError) {
            console.error("JSON parsing also failed:", jsonError);
            displayError(loadError, `Failed to parse data. Ensure it's a valid JavaScript object literal or JSON. Error: ${error.message || 'Syntax Error'} / ${jsonError.message}`);
            currentToolsData = {};
            manageArea.classList.add("hidden");
            outputArea.classList.add("hidden");
            disableButtons(false);
            return;
          }
        }
      }
      // Process loaded data: remove category, ensure appID
      for (const key in currentToolsData) {
        if (currentToolsData.hasOwnProperty(key)) {
          const tool = currentToolsData[key];
          if (tool && typeof tool === 'object') {
            if (tool.hasOwnProperty('category')) {
              console.log(`Removing 'category' from tool: ${key}`);
              delete tool.category;
              dataNeedsUpdate = true;
            }
            if (!tool.appID || typeof tool.appID !== 'string' || tool.appID.length < 10) {
              console.log(`Generating new appID for tool: ${key}`);
              tool.appID = generateUUIDv4();
              dataNeedsUpdate = true;
            }
          }
        }
      }
      // Base64画像圧縮
      const compressed = await compressAllBase64ImagesInData();
      if (compressed) dataNeedsUpdate = true;
      if (dataNeedsUpdate) {
        console.log("Data was modified (category removed, appID added, or image compressed), updating output and input fields.");
        updateOutput();
        dataInput.value = dataOutput.value;
      }
      updateSuggestions();
      renderToolList();
      manageArea.classList.remove("hidden");
      outputArea.classList.remove("hidden");
      if (!dataNeedsUpdate) {
        updateOutput();
      }
      disableButtons(false);
    }

    function renderToolList() {
      toolList.innerHTML = "";
      // Sort keys using localeCompare with numeric option for natural sort
      const keys = Object.keys(currentToolsData).sort((a, b) => {
        return a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' });
      });

      if (keys.length === 0) {
        toolList.innerHTML = `<p style="padding: 1rem 1.2rem; color: var(--secondary-color);">No tools loaded or defined yet. Click "Add New Tool" to start.</p>`;
        return;
      }
      keys.forEach((key) => {
        const tool = currentToolsData[key] || {};
        const item = document.createElement("div");
        item.classList.add("tool-item");
        const infoSpan = document.createElement("span");
        const keySpan = document.createElement("span");
        keySpan.classList.add("tool-key");
        keySpan.textContent = key;
        infoSpan.appendChild(keySpan);
        infoSpan.appendChild(document.createTextNode(` ${tool.title || "(No Title)"}`));
        item.appendChild(infoSpan);
        const editButton = document.createElement("button");
        editButton.textContent = "Edit";
        editButton.onclick = (e) => { e.stopPropagation(); showEditForm(key); };
        item.appendChild(editButton);
        toolList.appendChild(item);
      });
    }

    function getTodayDateString() {
      const today = new Date();
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, "0");
      const day = String(today.getDate()).padStart(2, "0");
      return `${year}-${month}-${day}`;
    }

    function showEditForm(toolKey) {
      clearError(saveError);
      clearPasteError('editImage');
      clearPasteError('editImageLarge');
      editForm.reset(); // Resets form fields to default

      // Manually reset Base64 states because form.reset() doesn't trigger input events or clear custom classes
      clearBase64Image('editImage', 'editImagePreview');
      clearBase64Image('editImageLarge', 'editImageLargePreview');

      document.getElementById("editToolId").value = toolKey || "";

      if (toolKey && currentToolsData[toolKey]) {
        const toolData = currentToolsData[toolKey];
        formTitle.textContent = `Edit Tool: ${toolKey}`;
        deleteToolBtn.classList.remove("hidden");
        editAppIDInput.value = toolData.appID || generateUUIDv4(); // Ensure appID, fallback if somehow missing
        document.getElementById("editToolKey").value = toolKey;
        document.getElementById("editToolKey").readOnly = true;
        document.getElementById("editTitle").value = toolData.title || "";
        document.getElementById("editImage").value = toolData.image || "";
        document.getElementById("editImageLarge").value = toolData.imageLarge || "";
        document.getElementById("editVersion").value = toolData.version || "";
        document.getElementById("editUpdated").value = toolData.updated || "";
        document.getElementById("editDocsUrl").value = toolData.docsUrl || "";
        document.getElementById("editPlatform").value = toolData.platform || "";
        document.getElementById("editCategoryType").value = toolData.categoryType || "";
        editDescriptionInput.value = toolData.descriptionMarkdown !== undefined ? toolData.descriptionMarkdown : (toolData.description || "");
        editDetailedDescriptionInput.value = toolData.detailedDescriptionMarkdown !== undefined ? toolData.detailedDescriptionMarkdown : (toolData.detailedDescription || "");
        if (typeof toolData.downloadUrl === 'object' && toolData.downloadUrl !== null) {
          document.getElementById("editDownloadUrl").value = toolData.downloadUrl.default || "";
          document.getElementById("editDownloadUrlWindows").value = toolData.downloadUrl.windows || "";
          document.getElementById("editDownloadUrlLinux").value = toolData.downloadUrl.linux || "";
        } else {
          document.getElementById("editDownloadUrl").value = toolData.downloadUrl || "";
          document.getElementById("editDownloadUrlWindows").value = toolData.downloadUrl_windows || "";
          document.getElementById("editDownloadUrlLinux").value = toolData.downloadUrl_linux || "";
        }
        // Update previews after setting values, this will handle Base64 UI
        updateImagePreview('editImage', 'editImagePreview');
        updateImagePreview('editImageLarge', 'editImageLargePreview');
      } else {
        formTitle.textContent = "Add New Tool";
        deleteToolBtn.classList.add("hidden");
        editAppIDInput.value = generateUUIDv4();
        document.getElementById("editToolKey").readOnly = false;
        let i = 1;
        let suggestedKey = `newTool${i}`;
        while (currentToolsData.hasOwnProperty(suggestedKey)) { i++; suggestedKey = `newTool${i}`; }
        document.getElementById("editToolKey").value = suggestedKey;
        document.getElementById("editUpdated").value = getTodayDateString();
        // Other fields are reset by editForm.reset()
        // Previews are reset by clearBase64Image calls at the beginning
      }
      editFormContainer.classList.remove("hidden");
      editFormContainer.scrollIntoView({ behavior: "smooth", block: "nearest" });
      setTimeout(() => {
        const firstFocusable = toolKey ? document.getElementById("editTitle") : document.getElementById("editToolKey");
        if (firstFocusable) firstFocusable.focus();
      }, 150);
    }

    function hideEditForm() {
      editFormContainer.classList.add("hidden");
      editForm.reset(); // Standard form reset
      clearError(saveError);
      clearPasteError('editImage');
      clearPasteError('editImageLarge');

      // Explicitly reset image fields and their UI states
      clearBase64Image('editImage', 'editImagePreview');
      clearBase64Image('editImageLarge', 'editImageLargePreview');

      document.getElementById("editToolKey").readOnly = false;
    }

    async function handleSaveTool(event) {
      event.preventDefault();
      disableButtons(true, "Saving...");
      clearError(saveError);
      const originalKey = document.getElementById("editToolId").value;
      const newKey = document.getElementById("editToolKey").value.trim();
      const appID = editAppIDInput.value.trim();

      if (!newKey) { displayError(saveError, "Tool Key is required."); document.getElementById("editToolKey").focus(); disableButtons(false); return; }
      if (!/^[a-zA-Z0-9-_]+$/.test(newKey)) { displayError(saveError, "Tool Key can only contain letters, numbers, hyphens (-), and underscores (_)."); document.getElementById("editToolKey").focus(); disableButtons(false); return; }
      if ((!originalKey || originalKey !== newKey) && currentToolsData.hasOwnProperty(newKey)) { displayError(saveError, `Tool Key "${newKey}" already exists. Choose a unique key.`); document.getElementById("editToolKey").focus(); disableButtons(false); return; }
      if (!appID) { displayError(saveError, "App ID is missing. Please reload or add the tool again."); disableButtons(false); return; }

      const descriptionMarkdown = editDescriptionInput.value.trim();
      const detailedDescriptionMarkdown = editDetailedDescriptionInput.value.trim();
      const descriptionHtml = descriptionMarkdown ? marked.parse(descriptionMarkdown) : "";
      const detailedDescriptionHtml = detailedDescriptionMarkdown ? marked.parse(detailedDescriptionMarkdown) : "";

      const toolData = {
        appID: appID,
        title: document.getElementById("editTitle").value.trim(),
        image: document.getElementById("editImage").value.trim(), // This will have Base64 if pasted
        imageLarge: document.getElementById("editImageLarge").value.trim(), // Same here
        version: document.getElementById("editVersion").value.trim(),
        updated: document.getElementById("editUpdated").value.trim(),
        descriptionMarkdown: descriptionMarkdown,
        description: descriptionHtml,
        detailedDescriptionMarkdown: detailedDescriptionMarkdown,
        detailedDescription: detailedDescriptionHtml,
        docsUrl: document.getElementById("editDocsUrl").value.trim(),
        platform: document.getElementById("editPlatform").value.trim(),
        categoryType: document.getElementById("editCategoryType").value.trim(),
      };
      const dlDefault = document.getElementById("editDownloadUrl").value.trim();
      const dlWindows = document.getElementById("editDownloadUrlWindows").value.trim();
      const dlLinux = document.getElementById("editDownloadUrlLinux").value.trim();
      if (dlWindows || dlLinux) { // If any platform specific URL exists
        if (dlDefault) toolData.downloadUrl = { default: dlDefault }; // Store default under object
        else toolData.downloadUrl = {}; // Ensure downloadUrl is an object

        if (dlWindows) toolData.downloadUrl.windows = dlWindows;
        if (dlLinux) toolData.downloadUrl.linux = dlLinux;

        // Remove old flat properties if they exist and new object structure is used
        delete toolData.downloadUrl_windows;
        delete toolData.downloadUrl_linux;

      } else if (dlDefault) { // Only default URL
        toolData.downloadUrl = dlDefault;
        // Remove object structure if only default exists now
        delete toolData.downloadUrl_windows;
        delete toolData.downloadUrl_linux;
      } else { // No download URLs
        delete toolData.downloadUrl;
        delete toolData.downloadUrl_windows;
        delete toolData.downloadUrl_linux;
      }

      Object.keys(toolData).forEach((key) => {
        if (key !== 'appID' &&
          key !== 'descriptionMarkdown' &&
          key !== 'detailedDescriptionMarkdown' &&
          (toolData[key] === "" || toolData[key] === null || toolData[key] === undefined || (typeof toolData[key] === 'object' && Object.keys(toolData[key]).length === 0))
        ) {
          delete toolData[key];
        }
      });

      if (!descriptionMarkdown) { delete toolData.description; delete toolData.descriptionMarkdown; }
      if (!detailedDescriptionMarkdown) { delete toolData.detailedDescription; delete toolData.detailedDescriptionMarkdown; }

      if (originalKey && originalKey !== newKey && currentToolsData.hasOwnProperty(originalKey)) {
        delete currentToolsData[originalKey];
      }
      currentToolsData[newKey] = toolData;
      console.log("Tool saved:", newKey, toolData);

      updateOutput(); // This will also sort keys for the output
      dataInput.value = dataOutput.value; // Update input field to reflect the saved state

      // It's better to call renderToolList and other updates directly instead of full handleLoadData if possible,
      // to avoid re-parsing and potential data loss if dataInput was manually changed.
      // However, handleLoadData also does cleanup (appID, category removal) which might be desired.
      // For simplicity and robustness of current logic, we'll keep handleLoadData.
      // If performance becomes an issue with very large datasets, this could be optimized.
      await handleLoadData(); // This will re-render list, update suggestions, etc.
      // The form will be hidden by handleLoadData's call to hideEditForm()
    }

    async function handleDeleteTool() {
      const toolKey = document.getElementById("editToolId").value;
      if (!toolKey || !currentToolsData.hasOwnProperty(toolKey)) { displayError(saveError, "Cannot delete: Invalid tool key or tool not found."); return; }
      if (confirm(`Are you sure you want to delete the tool "${toolKey}"? This action cannot be undone.`)) {
        disableButtons(true, "Deleting...");
        delete currentToolsData[toolKey];
        console.log("Tool deleted:", toolKey);
        updateOutput();
        dataInput.value = dataOutput.value;
        await handleLoadData(); // Re-render and hide form
      }
    }

    function updateOutput() {
      try {
        const sortedData = {};
        // Sort keys for the output JSON, consistent with the tool list display
        Object.keys(currentToolsData).sort((a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' }))
          .forEach(key => {
            sortedData[key] = currentToolsData[key];
          });
        dataOutput.value = JSON.stringify(sortedData, null, 2);
        clearError(loadError); // Clear any previous load errors if output is successful
      } catch (error) {
        dataOutput.value = "Error generating output JSON.";
        console.error("Error stringifying data:", error);
        displayError(loadError, `Error generating output: ${error.message}`); // Display error in loadError area
      }
      clearCopyStatus();
    }

    async function copyOutputToClipboard() {
      const textToCopy = dataOutput.value;
      if (!textToCopy || textToCopy === "Error generating output JSON.") {
        showCopyStatus("Nothing valid to copy.", false);
        return;
      }
      try {
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(textToCopy);
          showCopyStatus("Copied!", true);
        } else {
          dataOutput.select();
          if (document.execCommand('copy')) { showCopyStatus("Copied! (fallback)", true); }
          else { throw new Error('Fallback copy command failed'); }
          window.getSelection()?.removeAllRanges();
          dataOutput.blur();
        }
      } catch (err) {
        console.error("Copy failed: ", err);
        showCopyStatus("Copy failed!", false);
      }
    }

    function showCopyStatus(message, success) {
      copyStatus.textContent = message;
      copyStatus.className = success ? 'success' : 'fail';
      copyStatus.style.opacity = '1';
      setTimeout(clearCopyStatus, success ? 2000 : 3000);
    }

    function clearCopyStatus() {
      copyStatus.style.opacity = '0';
      setTimeout(() => { if (copyStatus.style.opacity === '0') { copyStatus.textContent = ""; copyStatus.className = ""; } }, 300);
    }

    // 指定inputとpreviewのBase64状態をリセットする関数
    function clearBase64Image(inputId, previewId) {
      const input = document.getElementById(inputId);
      const preview = document.getElementById(previewId);
      const statusMessage = document.getElementById(inputId + 'Base64Status');
      if (input) {
        input.value = '';
        input.classList.remove('is-base64-loaded');
      }
      if (preview) {
        preview.src = '#';
        preview.style.display = 'none';
        preview.classList.remove('has-base64');
      }
      if (statusMessage) {
        statusMessage.classList.add('hidden');
      }
    }

    // platform/categoryType候補をdatalistに反映する関数
    function updateSuggestions() {
      suggestions.platforms.clear();
      suggestions.categoryTypes.clear();
      for (const key in currentToolsData) {
        if (currentToolsData.hasOwnProperty(key)) {
          const tool = currentToolsData[key];
          if (tool.platform) {
            tool.platform.split(',').map(s => s.trim()).filter(Boolean).forEach(p => suggestions.platforms.add(p));
          }
          if (tool.categoryType) {
            tool.categoryType.split(',').map(s => s.trim()).filter(Boolean).forEach(c => suggestions.categoryTypes.add(c));
          }
        }
      }
      // datalistへ反映
      platformSuggestionsEl.innerHTML = Array.from(suggestions.platforms).sort().map(p => `<option value="${p}">`).join('');
      categoryTypeSuggestionsEl.innerHTML = Array.from(suggestions.categoryTypes).sort().map(c => `<option value="${c}">`).join('');
    }

    // Initial setup if needed, e.g. for marked.js
    if (window.marked) {
      marked.setOptions({
        breaks: true, // Convert GFM line breaks to <br>
        gfm: true,    // Enable GFM tables and other features
      });
    }

  </script>
</body>

</html>