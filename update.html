<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>更新履歴 - PEX Server</title>
    <link rel="icon" href="https://pexserver.github.io/libs/Assets/images/home.png" type="image/x-icon">
    <link rel="shortcut icon" href="https://pexserver.github.io/libs/Assets/images/home.png" type="image/x-icon">
    <meta name="description" content="PEX Serverのアップデート履歴・バージョン情報を掲載しています。">
    <!-- OGP設定 -->
    <meta property="og:title" content="更新履歴 - PEX Server">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://pexserver.github.io/update.html">
    <meta property="og:image" content="https://pexserver.github.io/libs/Assets/images/ogp.png">
    <meta property="og:description" content="PEX Serverのアップデート履歴・バージョン情報を掲載しています。">
    <meta property="og:site_name" content="PEX Server">
    <meta property="og:locale" content="ja_JP">
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@PEXkoukunn">
    <!-- iOS設定 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="PEX Update">
    <link rel="apple-touch-icon" href="https://pexserver.github.io/libs/Assets/images/home.png">
    <link rel="stylesheet" href="./libs/css/update.css">
</head>
<body>
    <header>
        <div class="container">
            <a href="/index.html" style="font-size:1.3em;font-weight:600;letter-spacing:0.05em;">PEX Server</a>
            <nav>
                <a href="/update.html" style="margin-left:1.5em;font-weight:500;">更新履歴</a>
                <a href="/about.html" style="margin-left:1.5em;font-weight:500;">About</a>
            </nav>
        </div>
    </header>
    <main>
        <div class="container fade-in">
            <section class="hero">
                <h1>PEX Server  更新履歴</h1>
                <p>PEX Serverの主なアップデート履歴・バージョン情報を掲載しています。</p>
            </section>
            <!-- 動的に履歴を表示するセクション -->
            <div id="updates-dynamic"></div>
        </div>
    </main>
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="copyright">
                    &copy; 2025 PEX Server 
                </div>
                <div class="footer-links">
                    <a href="/index.html">ホーム</a>
                    <a href="/about.html">About</a>
                    <a href="/privacy.html">プライバシーポリシー</a>
                </div>
            </div>
        </div>
    </footer>
    <script>
    // updates.jsonを読み込んで動的に履歴を表示
    async function loadUpdates() {
        try {
            const res = await fetch('./updates.json');
            const data = await res.json();
            const container = document.getElementById('updates-dynamic');
            if (!container) return;
            
            // カテゴリフィルターUI追加
            const filterDiv = document.createElement('div');
            filterDiv.style.margin = '1em 0';
            // カテゴリリスト生成
            const categoryOptions = data.categories.map(cat => `<option value="${cat.name}">${cat.name}</option>`).join('');
            filterDiv.innerHTML = `
                <label for="category-filter" style="font-weight:600;margin-right:0.5em;">カテゴリフィルター:</label>
                <select id="category-filter" style="padding:0.3em 1em;margin-right:1em;">
                    <option value="all">すべて</option>
                    ${categoryOptions}
                </select>
                <label for="version-filter" style="font-weight:600;margin-right:0.5em;">バージョン種別フィルター:</label>
                <select id="version-filter" style="padding:0.3em 1em;">
                    <option value="all">すべて</option>
                    <option value="stable">Stable</option>
                    <option value="beta">Beta</option>
                    <option value="alpha">Alpha</option>
                </select>
            `;
            container.appendChild(filterDiv);

            // カテゴリごとにsectionを生成し、sectionを配列で保持
            const sections = [];
            data.categories.forEach((category, index) => {
                // カテゴリタイトル
                const section = document.createElement('section');
                section.className = 'section fade-in';
                section.style.animationDelay = (index * 0.2) + 's';

                const h2 = document.createElement('h2');
                h2.textContent = category.name + ' の更新履歴';
                section.appendChild(h2);

                // テーブル
                const table = document.createElement('table');
                table.className = 'update-history';
                table.style.width = '100%';
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>日付</th>
                            <th>バージョン</th>
                            <th>主な変更点</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                `;

                const tbody = table.querySelector('tbody');

                // アップデート種別判定関数
                function getVersionType(version) {
                    const v = version.toLowerCase();
                    if (/[-_]?beta\b/.test(v)) return 'beta';
                    if (/[-_]?alpha\b/.test(v)) return 'alpha';
                    if (/[-_]?stable\b/.test(v)) return 'stable';
                    return 'stable';
                }

                // フィルター・ソート用データ生成
                let updates = category.updates.map(update => ({
                    ...update,
                    type: getVersionType(update.version)
                }));
                // Stable→Beta→Alpha順でソート
                const typeOrder = { stable: 0, beta: 1, alpha: 2 };
                updates.sort((a, b) => typeOrder[a.type] - typeOrder[b.type]);

                // 描画関数
                function renderTable(versionType) {
                    tbody.innerHTML = '';
                    updates.forEach(update => {
                        if (versionType !== 'all' && update.type !== versionType) return;
                        let versionWithBadge = update.version;
                        if (update.type === 'beta') {
                            versionWithBadge = `${update.version} <span class="version-badge badge-beta">Beta</span>`;
                        } else if (update.type === 'alpha') {
                            versionWithBadge = `${update.version} <span class="version-badge badge-alpha">Alpha</span>`;
                        } else {
                            versionWithBadge = `${update.version} <span class="version-badge badge-stable">Stable</span>`;
                        }
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${update.date}</td>
                            <td>${versionWithBadge}</td>
                            <td>${update.description}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                }

                // 初期描画
                renderTable('all');
                section.appendChild(table);
                container.appendChild(section);
                sections.push({ name: category.name, section, renderTable });
            });

            // フィルターイベント
            const categoryFilter = document.getElementById('category-filter');
            const versionFilter = document.getElementById('version-filter');
            function applyFilters() {
                const selectedCategory = categoryFilter.value;
                const selectedVersion = versionFilter.value;
                sections.forEach(({ name, section, renderTable }) => {
                    // カテゴリフィルター
                    if (selectedCategory !== 'all' && name !== selectedCategory) {
                        section.style.display = 'none';
                    } else {
                        section.style.display = '';
                        renderTable(selectedVersion);
                    }
                });
            }
            categoryFilter.addEventListener('change', applyFilters);
            versionFilter.addEventListener('change', applyFilters);
        } catch (error) {
            console.error('更新履歴の読み込みに失敗しました:', error);
            const container = document.getElementById('updates-dynamic');
            if (container) {
                container.innerHTML = '<div class="error-message">更新履歴の読み込みに失敗しました。後でもう一度お試しください。</div>';
            }
        }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        // アニメーション用のスクロール検出
        const observeElements = () => {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('visible');
                        observer.unobserve(entry.target);
                    }
                });
            }, { threshold: 0.1 });
            
            document.querySelectorAll('.fade-in').forEach(el => {
                observer.observe(el);
            });
        };
        
        // 更新履歴の読み込み
        loadUpdates().then(() => {
            // 動的に生成された要素にもアニメーションを適用
            document.querySelectorAll('.fade-in').forEach(el => {
                if (!el.style.animationDelay) {
                    el.style.animationDelay = '0.2s';
                }
            });
            
            observeElements();
        });
    });
    </script>
</body>
</html>
